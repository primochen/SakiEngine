# ğŸ¯ å‰§æƒ…æµç¨‹å›¾ç³»ç»Ÿ - å®Œæˆæ€»ç»“

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. æ ¸å¿ƒç»„ä»¶
- âœ… **StoryFlowchartManager** - æµç¨‹å›¾æ•°æ®ç®¡ç†å™¨
  - èŠ‚ç‚¹çš„å¢åˆ æ”¹æŸ¥
  - æ•°æ®æŒä¹…åŒ–å­˜å‚¨
  - èŠ‚ç‚¹è§£é”çŠ¶æ€ç®¡ç†
  - è‡ªåŠ¨å­˜æ¡£å…³è”

- âœ… **StoryFlowchartAnalyzer** - è„šæœ¬è‡ªåŠ¨åˆ†æå™¨
  - æ‰«ææ•´ä¸ªè„šæœ¬
  - è¯†åˆ«ç« èŠ‚ã€åˆ†æ”¯ã€æ±‡åˆç‚¹ã€ç»“å±€
  - è‡ªåŠ¨æ„å»ºèŠ‚ç‚¹å…³ç³»æ ‘

- âœ… **StoryFlowchartScreen** - å¯è§†åŒ–UIç•Œé¢
  - äº¤äº’å¼æµç¨‹å›¾å±•ç¤º
  - ç¼©æ”¾ã€å¹³ç§»æ”¯æŒ
  - èŠ‚ç‚¹ç‚¹å‡»è·³è½¬
  - ç»“å±€ç»Ÿè®¡æ˜¾ç¤º

- âœ… **GameManager é›†æˆ**
  - ç« èŠ‚å¼€å§‹æ—¶è‡ªåŠ¨å­˜æ¡£
  - åˆ†æ”¯é€‰æ‹©å‰è‡ªåŠ¨å­˜æ¡£
  - æµç¨‹å›¾ç®¡ç†å™¨åˆå§‹åŒ–

### 2. èŠ‚ç‚¹ç±»å‹
- **ç« èŠ‚èŠ‚ç‚¹** (è“è‰²) - æ£€æµ‹ç« èŠ‚èƒŒæ™¯æ—¶åˆ›å»º
- **åˆ†æ”¯èŠ‚ç‚¹** (æ©™è‰²) - menu å‘½ä»¤æ—¶åˆ›å»º
- **æ±‡åˆèŠ‚ç‚¹** (ç´«è‰²) - å¤šåˆ†æ”¯æ±‡èšæ—¶åˆ›å»º
- **ç»“å±€èŠ‚ç‚¹** (ç»¿è‰²/ç°è‰²) - return å‰æœ€åä¸€ä¸ª scene

### 3. è‡ªåŠ¨å­˜æ¡£æœºåˆ¶
- ç« èŠ‚å¼€å§‹: æ£€æµ‹åˆ° `chapter`, `ch\d+`, `prologue`, `epilogue`
- åˆ†æ”¯é€‰æ‹©: æ£€æµ‹åˆ° `menu` èŠ‚ç‚¹
- å­˜æ¡£IDæ ¼å¼: `auto_[nodeId]`
- è‡ªåŠ¨å…³è”åˆ°æµç¨‹å›¾èŠ‚ç‚¹

## ğŸ“‚ åˆ›å»ºçš„æ–‡ä»¶

```
lib/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ game/
â”‚   â”‚   â”œâ”€â”€ story_flowchart_manager.dart         # âœ… æµç¨‹å›¾ç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ story_flowchart_analyzer.dart        # âœ… è„šæœ¬åˆ†æå™¨
â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â””â”€â”€ story_flowchart_screen.dart          # âœ… æµç¨‹å›¾ç•Œé¢
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ story_flowchart_helper.dart          # âœ… è¾…åŠ©å·¥å…·
â””â”€â”€ STORY_FLOWCHART_GUIDE.md                      # âœ… ä½¿ç”¨æ–‡æ¡£
```

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶

```
lib/src/game/game_manager.dart
â”œâ”€â”€ å¯¼å…¥ story_flowchart_manager.dart
â”œâ”€â”€ æ·»åŠ  _flowchartManager å®ä¾‹
â”œâ”€â”€ æ·»åŠ  _checkAndCreateAutoSave() æ–¹æ³•
â”œâ”€â”€ æ·»åŠ  _findNearestLabel() æ–¹æ³•
â”œâ”€â”€ æ·»åŠ  _extractChapterName() æ–¹æ³•
â”œâ”€â”€ BackgroundNode å¤„ç†ä¸­æ·»åŠ è‡ªåŠ¨å­˜æ¡£è§¦å‘
â”œâ”€â”€ MenuNode å¤„ç†ä¸­æ·»åŠ è‡ªåŠ¨å­˜æ¡£è§¦å‘
â””â”€â”€ startGame() ä¸­åˆå§‹åŒ–æµç¨‹å›¾ç®¡ç†å™¨
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿé›†æˆï¼ˆ3æ­¥ï¼‰

#### 1. åœ¨ä¸»èœå•æ·»åŠ æŒ‰é’®
```dart
import 'package:sakiengine/src/utils/story_flowchart_helper.dart';

// æ·»åŠ åˆ°ä¸»èœå•
ElevatedButton(
  onPressed: () {
    StoryFlowchartHelper.showFlowchart(
      context,
      analyzeScriptFirst: true,
      onLoadSave: (saveSlot) {
        widget.onLoadGameWithSave?.call(saveSlot);
      },
    );
  },
  child: const Text('å‰§æƒ…æµç¨‹å›¾'),
)
```

#### 2. ç¡®ä¿è„šæœ¬ç¬¦åˆå‘½åè§„èŒƒ
```sks
# ç« èŠ‚æ ‡è¯†ç¤ºä¾‹
scene chapter1_opening       # âœ… ä¼šè¢«è¯†åˆ«
scene ch01_school           # âœ… ä¼šè¢«è¯†åˆ«
scene prologue_intro        # âœ… ä¼šè¢«è¯†åˆ«

# åˆ†æ”¯ç¤ºä¾‹
label choice_point
menu
    "é€‰é¡¹A" -> route_a
    "é€‰é¡¹B" -> route_b

# ç»“å±€ç¤ºä¾‹
label ending_true
scene ending_happy
    "Happy End!"
return
```

#### 3. é¦–æ¬¡å¯åŠ¨æ—¶åˆ†æè„šæœ¬
```dart
// åœ¨æ¸¸æˆå¯åŠ¨æˆ–é¦–æ¬¡æ‰“å¼€æµç¨‹å›¾æ—¶
import 'package:sakiengine/src/game/story_flowchart_analyzer.dart';

final analyzer = StoryFlowchartAnalyzer();
await analyzer.analyzeScript();
```

## ğŸ¨ ç•Œé¢é¢„è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† å‰§æƒ…æµç¨‹å›¾          ç»“å±€è¾¾æˆ: 3/5         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚   [åºç« ] â”€â”€â”€â†’ [ç¬¬1ç« ] â”€â”€â”€â†’ [åˆ†æ”¯A]          â”‚
â”‚                  â”‚                           â”‚
â”‚                  â†“                           â”‚
â”‚              [åˆ†æ”¯B] â”€â”€â”€â†’ [ç»“å±€1] âœ“          â”‚
â”‚                  â”‚                           â”‚
â”‚                  â†“                           â”‚
â”‚              [æ±‡åˆç‚¹] â”€â†’ [ç»“å±€2] âœ—           â”‚
â”‚                                              â”‚
â”‚  å›¾ä¾‹:                                       â”‚
â”‚  ğŸ”µ ç« èŠ‚  ğŸŸ  åˆ†æ”¯  ğŸŸ£ æ±‡åˆ  ğŸŸ¢ å·²è¾¾æˆç»“å±€    â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ•°æ®ç»“æ„

### StoryFlowNode
```dart
{
  "id": "chapter_åºç« ",
  "label": "prologue",
  "type": "chapter",
  "displayName": "åºç« ",
  "scriptIndex": 0,
  "chapterName": "åºç« ",
  "parentNodeId": null,
  "childNodeIds": ["branch_100"],
  "autoSaveId": "auto_chapter_åºç« ",
  "isUnlocked": true,
  "firstReachedTime": "2025-10-03T12:00:00",
  "metadata": {}
}
```

## ğŸ” è°ƒè¯•å‘½ä»¤

```dart
// 1. æŸ¥çœ‹æµç¨‹å›¾ç»Ÿè®¡
final stats = StoryFlowchartManager().exportData()['stats'];
print(stats);
// è¾“å‡º: {totalNodes: 15, unlockedNodes: 8, totalEndings: 5, unlockedEndings: 3}

// 2. å¯¼å‡ºå®Œæ•´æ•°æ®
final data = StoryFlowchartManager().exportData();
print(jsonEncode(data));

// 3. é‡ç½®å¹¶é‡æ–°åˆ†æ
await StoryFlowchartHelper.resetAndAnalyzeScript();

// 4. æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹
final nodes = StoryFlowchartManager().nodes;
nodes.forEach((id, node) {
  print('$id: ${node.displayName} (${node.isUnlocked ? "å·²è§£é”" : "æœªè§£é”"})');
});
```

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–
- [ ] å¤§å‹è„šæœ¬çš„å¢é‡åˆ†æï¼ˆåªåˆ†æå˜æ›´éƒ¨åˆ†ï¼‰
- [ ] èŠ‚ç‚¹è™šæ‹ŸåŒ–æ¸²æŸ“ï¼ˆåªæ¸²æŸ“å¯è§åŒºåŸŸï¼‰
- [ ] åå°çº¿ç¨‹åˆ†æè„šæœ¬

### 2. åŠŸèƒ½å¢å¼º
- [ ] æ”¯æŒå¤šé‡ç»“å±€ï¼ˆä¸€ä¸ªç»“å±€æœ‰å¤šä¸ªå˜ä½“ï¼‰
- [ ] æ·»åŠ å‰§æƒ…æ‘˜è¦å’ŒCGé¢„è§ˆ
- [ ] æ”¯æŒæœç´¢åŠŸèƒ½ï¼ˆæŒ‰ç« èŠ‚ã€æ ‡ç­¾æœç´¢ï¼‰
- [ ] å¯¼å‡ºæµç¨‹å›¾ä¸ºå›¾ç‰‡

### 3. UIæ”¹è¿›
- [ ] æ›´ç²¾ç¾çš„èŠ‚ç‚¹æ ·å¼ï¼ˆå›¾æ ‡ã€åŠ¨ç”»ï¼‰
- [ ] åŠ›å¯¼å‘å›¾å¸ƒå±€ç®—æ³•
- [ ] å°åœ°å›¾å¯¼èˆª
- [ ] æ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢

### 4. æ•°æ®åˆ†æ
- [ ] ç©å®¶è·¯å¾„ç»Ÿè®¡ï¼ˆæœ€å—æ¬¢è¿çš„è·¯çº¿ï¼‰
- [ ] ç»“å±€è¾¾æˆç‡æ’è¡Œ
- [ ] æ¸¸æˆæ—¶é•¿ç»Ÿè®¡

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡ä½¿ç”¨**: éœ€è¦å…ˆè¿è¡Œ `analyzeScript()` åˆ†æè„šæœ¬
2. **å‘½åè§„èŒƒ**: ç« èŠ‚èƒŒæ™¯å¿…é¡»åŒ…å«å…³é”®å­—ï¼ˆchapter/ch\d+/prologue/epilogueï¼‰
3. **æ€§èƒ½**: å¤§å‹è„šæœ¬ï¼ˆ1000+ èŠ‚ç‚¹ï¼‰å¯èƒ½éœ€è¦å‡ ç§’é’Ÿåˆ†ææ—¶é—´
4. **å­˜å‚¨**: æµç¨‹å›¾æ•°æ®ä¿å­˜åœ¨ `UnifiedGameDataManager` çš„ `story_flowchart` é”®ä¸‹
5. **å…¼å®¹æ€§**: éœ€è¦ Flutter 3.4.3+ å’Œæ‰€æœ‰å·²æœ‰ä¾èµ–

## ğŸ‰ å®ŒæˆçŠ¶æ€

**ç³»ç»Ÿå·²å®Œå…¨å®ç°å¹¶å¯ç›´æ¥ä½¿ç”¨ï¼**

æ ¸å¿ƒåŠŸèƒ½:
- âœ… è‡ªåŠ¨è¯†åˆ«ç« èŠ‚ã€åˆ†æ”¯ã€ç»“å±€
- âœ… è‡ªåŠ¨åˆ›å»ºå­˜æ¡£
- âœ… å¯è§†åŒ–æµç¨‹å›¾ç•Œé¢
- âœ… å¿«é€Ÿè·³è½¬åŠŸèƒ½
- âœ… ç»“å±€ç»Ÿè®¡
- âœ… æ•°æ®æŒä¹…åŒ–

---

**æ­å–œï¼ä½ çš„æ¸¸æˆç°åœ¨æ‹¥æœ‰äº†ä¸“ä¸šçº§çš„å‰§æƒ…å¯¼èˆªç³»ç»Ÿï¼** ğŸ®âœ¨
