# 问题解决记录

## CG差分切换时露出后面背景的bug

### 问题描述
在游戏第一次执行CG差分切换的时候，两个CG的过渡动画会露出后面的背景。

例如：
```
cg cg_cp1_5 1
////手放下去
x2 "你看，那颗最亮的星星，就是人马座α星，或者叫做"射手座的心脏"。"
l"你对星星挺了解的嘛。"
cg cg_cp1_5 2
////抬手
```

### 失败的尝试

#### 尝试1: 修改CompositeCgRenderer缓存逻辑 ❌ **失败/无效**

**假设原因**: 认为是CompositeCgRenderer在加载新CG图像期间显示空白组件(`SizedBox.shrink()`)导致背景露出。

**修复方案**: 
- 添加了`_currentDisplays`缓存来保存当前显示的CG组件
- 在加载期间显示之前的CG图像而不是空白
- 在CompositeCgDisplay中添加过渡动画支持
- 创建了CompositeCgTransitionPainter用于处理图像间的过渡

**结果**: 完全无效，说明问题的根本原因不在CompositeCgRenderer的加载逻辑。

**教训**: 需要更仔细地分析渲染层级和时序，而不是仅仅关注单个组件的加载状态。

---

### 正在尝试的方案

#### 尝试2: 跳过首次CG显示的同步等待逻辑 🔄 **测试中**

**假设原因**: `SynchronizedCgDisplay`中的首次显示同步逻辑导致在等待所有图层准备期间显示空白(`_canShowLayers = false`)，从而露出背景。

**修复方案**: 
- 修改`SynchronizedCgDisplay.initState()`，无论首次显示还是非首次显示都直接允许显示图层(`_canShowLayers = true`)
- 跳过复杂的图层同步等待逻辑
- 简化`_onLayerReady`方法

**预期结果**: 第一次CG差分切换时不会有等待期间的空白，避免背景露出。

---

### 待分析的可能原因
- [ ] CgCharacterLayer的dissolve动画逻辑
- [ ] Widget生命周期和重建导致的闪烁
- [ ] 游戏渲染层级结构问题