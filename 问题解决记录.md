# 问题解决记录

## CG差分切换时露出后面背景的bug

### 问题描述
在游戏第一次执行CG差分切换的时候，两个CG的过渡动画会露出后面的背景。

例如：
```
cg cg_cp1_5 1
////手放下去
x2 "你看，那颗最亮的星星，就是人马座α星，或者叫做"射手座的心脏"。"
l"你对星星挺了解的嘛。"
cg cg_cp1_5 2
////抬手
```

### 失败的尝试

#### 尝试1: 修改CompositeCgRenderer缓存逻辑 ❌ **失败/无效**

**假设原因**: 认为是CompositeCgRenderer在加载新CG图像期间显示空白组件(`SizedBox.shrink()`)导致背景露出。

**修复方案**: 
- 添加了`_currentDisplays`缓存来保存当前显示的CG组件
- 在加载期间显示之前的CG图像而不是空白
- 在CompositeCgDisplay中添加过渡动画支持
- 创建了CompositeCgTransitionPainter用于处理图像间的过渡

**结果**: 完全无效，说明问题的根本原因不在CompositeCgRenderer的加载逻辑。

**教训**: 需要更仔细地分析渲染层级和时序，而不是仅仅关注单个组件的加载状态。

---

### 正在尝试的方案

#### 尝试2: 跳过首次CG显示的同步等待逻辑 ❌ **失败/无效**

**假设原因**: `SynchronizedCgDisplay`中的首次显示同步逻辑导致在等待所有图层准备期间显示空白(`_canShowLayers = false`)，从而露出背景。

**修复方案**: 
- 修改`SynchronizedCgDisplay.initState()`，无论首次显示还是非首次显示都直接允许显示图层(`_canShowLayers = true`)
- 跳过复杂的图层同步等待逻辑
- 简化`_onLayerReady`方法

**结果**: 依旧无效，问题不在同步等待逻辑。

**教训**: 问题可能在于Flutter的图像加载机制本身的延迟。

---

### 正在尝试的方案

#### 尝试3: CG预热系统 ❌ **完全无效**

**假设原因**: Flutter的图像加载机制导致CG差分切换时新图像还未加载完成，显示空白从而露出背景。

**修复方案**: 
- 创建专门的`CgPrewarmingManager`预热模块
- 类似CG预合成系统，在第一个CG显示时就预热后面50行脚本中出现的CG
- 提前加载并缓存CG图像到内存和Flutter的图像缓存中
- 修改`CompositeCgDisplay`优先使用预热的图像

**结果**: 预热系统完全正常工作，成功预热了所有CG差分（pose1_1和pose1_2），但**视觉上没有任何区别**，依旧露出背景。

**教训**: 问题根本不在图像加载延迟上。改了大量代码但视觉效果完全没变，说明我们找错了方向。

---

#### 尝试4: 修复CG首次显示判定逻辑 ❌ **完全无效**

**假设原因**: CG的"首次显示"判定逻辑有误，导致CG差分切换时出现错误的淡入淡出动画。

**修复方案**: 
将首次显示判定从基于`resourceId`改为基于完整的CG标识（包含pose和expression）。

**结果**: 完全无效，视觉效果没有任何改变，依旧露出背景。

**教训**: 问题不在首次显示判定逻辑上。

---

### 需要重新分析的根本问题

经过4次完全不同方向的尝试，都没有任何视觉效果改变，说明我们一直在错误的层面寻找问题。

真正的问题可能在于：
- [ ] **Flutter渲染机制**：Widget重建时的帧间隙问题
- [ ] **Stack层级渲染**：CG层与背景层的渲染时序问题  
- [ ] **CustomPainter绘制**：绘制过程中的空白帧
- [ ] **动画控制器**：AnimationController的时序同步问题

---

### 待分析的可能原因
- [ ] CgCharacterLayer的dissolve动画逻辑
- [ ] Widget生命周期和重建导致的闪烁
- [ ] 游戏渲染层级结构问题