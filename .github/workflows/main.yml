name: Build & Release

on:
  push:
    branches:
      - 'main'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  check-trigger:
    name: Check Push Message
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.evaluate.outputs.should_run }}
    steps:
      - name: Validate commit message
        id: evaluate
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          echo "ğŸ“© æœ€æ–°æäº¤ä¿¡æ¯:"
          echo "$COMMIT_MESSAGE"
          pattern='[0-9]{4}\.[0-9]{1,2}\.[0-9]{1,2}'
          if [[ -n "$COMMIT_MESSAGE" && "$COMMIT_MESSAGE" =~ $pattern ]]; then
            echo "âœ… æ£€æµ‹åˆ°æ—¥æœŸæ ¼å¼ï¼Œå…è®¸æ„å»º"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸ æ¨é€ä¿¡æ¯æœªåŒ…å«å½¢å¦‚YYYY.MM.DDçš„æ–‡æœ¬ï¼Œè·³è¿‡æ„å»º"
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi

  # Androidæ„å»º
  build-android:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    name: Build Android
    uses: ./.github/workflows/android-build.yml
    with:
      flutter_version: '3.35.1'
      working_directory: 'Engine'
      target_platform: 'android-arm64'
    secrets: inherit

  # iOSæ„å»º
  build-ios:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    name: Build iOS
    uses: ./.github/workflows/ios-build.yml
    with:
      flutter_version: '3.35.1'
      working_directory: 'Engine'
      enable_codesign: false
    secrets: inherit

  # macOSæ„å»º
  build-macos:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    name: Build macOS
    uses: ./.github/workflows/macos-build.yml
    with:
      flutter_version: '3.35.1'
      working_directory: 'Engine'
      create_dmg: true
    secrets: inherit

  # Windowsæ„å»º
  build-windows:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    name: Build Windows
    uses: ./.github/workflows/windows-build.yml
    with:
      flutter_version: '3.35.1'
      working_directory: 'Engine'
      architecture: 'x64'
    secrets: inherit

  # Linuxæ„å»º
  build-linux:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    name: Build Linux
    uses: ./.github/workflows/linux-build.yml
    with:
      flutter_version: '3.35.1'
      working_directory: 'Engine'
      architecture: 'amd64'
    secrets: inherit

  # å‘å¸ƒ
  publish:
    name: Publish Release
    needs: [check-trigger, build-android, build-ios, build-macos, build-windows, build-linux]
    if: needs.check-trigger.outputs.should_run == 'true'
    uses: ./.github/workflows/publish.yml
    with:
      version: ${{ needs.build-android.outputs.version }}
      artifacts_pattern: "/tmp/artifacts/release-Android/*.apk,/tmp/artifacts/release-iOS/*.ipa,/tmp/artifacts/release-macOS/*.dmg,/tmp/artifacts/release-Windows/*.zip,/tmp/artifacts/release-Linux-amd64/*.zip"
    secrets: inherit

  # ç‰ˆæœ¬æ›´æ–°
  update-version:
    name: Update Version
    needs: [check-trigger, build-android, build-ios, build-macos, build-windows, build-linux, publish]
    if: needs.check-trigger.outputs.should_run == 'true' && github.ref == 'refs/heads/main' && success()
    uses: ./.github/workflows/version-update.yml
    with:
      working_directory: 'Engine'
      version_increment: 'patch'
      branch: 'main'
    secrets: inherit
