name: Build & Release

on:
  push:
    branches:
      - 'main'
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  # Android构建
  build-android:
    name: Build Android
    uses: ./.github/workflows/android-build.yml
    with:
      flutter_version: '3.29.3'
      working_directory: 'Engine'
      target_platform: 'android-arm64'
    secrets: inherit

  # iOS构建
  build-ios:
    name: Build iOS
    uses: ./.github/workflows/ios-build.yml
    with:
      flutter_version: '3.29.3'
      working_directory: 'Engine'
      enable_codesign: false
    secrets: inherit

  # macOS构建
  build-macos:
    name: Build macOS
    uses: ./.github/workflows/macos-build.yml
    with:
      flutter_version: '3.29.3'
      working_directory: 'Engine'
      create_dmg: true
    secrets: inherit

  # Windows构建
  build-windows:
    name: Build Windows
    uses: ./.github/workflows/windows-build.yml
    with:
      flutter_version: '3.29.3'
      working_directory: 'Engine'
      architecture: 'x64'
    secrets: inherit

  # Linux构建
  build-linux:
    name: Build Linux
    uses: ./.github/workflows/linux-build.yml
    with:
      flutter_version: '3.29.3'
      working_directory: 'Engine'
      architecture: 'amd64'
    secrets: inherit

  # 发布
  publish:
    name: Publish Release
    needs: [build-android, build-ios, build-macos, build-windows, build-linux]
    uses: ./.github/workflows/publish.yml
    with:
      version: ${{ needs.build-android.outputs.version }}
      artifacts_pattern: "/tmp/artifacts/release-Android/*.apk,/tmp/artifacts/release-iOS/*.ipa,/tmp/artifacts/release-macOS/*.dmg,/tmp/artifacts/release-Windows/*.zip,/tmp/artifacts/release-Linux-amd64/*.zip"
    secrets: inherit

  # 版本更新
  update-version:
    name: Update Version
    needs: [build-android, build-ios, build-macos, build-windows, build-linux, publish]
    if: github.ref == 'refs/heads/main' && success()
    uses: ./.github/workflows/version-update.yml
    with:
      working_directory: 'Engine'
      version_increment: 'patch'
      branch: 'main'
    secrets: inherit
