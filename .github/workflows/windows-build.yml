name: Windows Build

on:
  workflow_call:
    inputs:
      flutter_version:
        required: false
        type: string
        default: '3.29.3'
      working_directory:
        required: false
        type: string
        default: '.'
      architecture:
        required: false
        type: string
        default: 'x64'
        description: 'Target architecture: x64 or arm64'
    outputs:
      version:
        description: "App version from pubspec.yaml"
        value: ${{ jobs.build-windows.outputs.version }}
      artifact_name:
        description: "Generated artifact name"
        value: ${{ jobs.build-windows.outputs.artifact_name }}

jobs:
  build-windows:
    name: Build Windows App
    runs-on: windows-2022
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      artifact_name: ${{ steps.build.outputs.artifact_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Get app version
        id: get_version
        working-directory: ${{ inputs.working_directory }}
        shell: bash
        run: |
          version=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Detected version: $version"
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          flutter-version: ${{ inputs.flutter_version }}
          channel: 'stable'
          cache: true
      
      - name: Flutter Pub Get
        working-directory: ${{ inputs.working_directory }}
        shell: bash
        run: |
          git config --global core.longpaths true
          flutter pub get
      
      - name: Pre-build diagnostics
        shell: bash
        run: |
          echo "ğŸ” æ„å»ºå‰è¯Šæ–­..."
          flutter doctor -v
          flutter pub outdated || true
          
          # æ£€æŸ¥è·¯å¾„é•¿åº¦
          pwd | wc -c
          
          # éªŒè¯Gameç›®å½•å’Œdefault_game.txt
          echo "ğŸ“ æ£€æŸ¥æ¸¸æˆç›®å½•..."
          ls -la Game/ || echo "Gameç›®å½•ä¸å­˜åœ¨"
          echo "ğŸ“„ default_game.txtå†…å®¹:"
          cat default_game.txt | xxd
          echo "ğŸ¯ æ¸¸æˆç›®å½•è·¯å¾„:"
          GAME_NAME=$(cat default_game.txt | tr -d '\r\n')
          echo "Game name: '$GAME_NAME'"
          ls -la "Game/$GAME_NAME/" || echo "æ¸¸æˆç›®å½•ä¸å­˜åœ¨"
          
          # æ¸…ç†å¯èƒ½çš„ç¼“å­˜é—®é¢˜
          cd Engine
          flutter clean
          flutter pub get
      
      - name: Build Windows App with retry
        shell: bash
        run: |
          echo "ğŸ”¨ ä½¿ç”¨build.shæ„å»ºWindowsåº”ç”¨"
          chmod +x build.sh
          
          # ç¬¬ä¸€æ¬¡å°è¯•
          if ! ./build.sh windows; then
            echo "âš ï¸ ç¬¬ä¸€æ¬¡æ„å»ºå¤±è´¥ï¼Œæ¸…ç†åé‡è¯•..."
            
            cd Engine
            flutter clean
            rm -rf build/windows
            flutter pub get
            cd ..
            
            # ç¬¬äºŒæ¬¡å°è¯•
            ./build.sh windows
          fi
      
      - name: Package Windows App
        id: build
        shell: pwsh
        run: |
          $arch = "${{ inputs.architecture }}"
          $version = (Get-Content Engine/pubspec.yaml | Select-String '^version:' | ForEach-Object { ($_ -split ' ')[1] } | ForEach-Object { ($_ -split '\+')[0] })
          
          if ($arch -eq "arm64") {
            $DestDir = "Engine\build\windows\SakiEngine-${version}-Windows-arm64"
            $SrcDir = "Engine\build\windows\arm64\runner\Release"
            $ZipName = "SakiEngine-${version}-Windows-arm64.zip"
          } else {
            $DestDir = "Engine\build\windows\SakiEngine-${version}-Windows-x64"
            $SrcDir = "Engine\build\windows\x64\runner\Release"
            $ZipName = "SakiEngine-${version}-Windows-x64.zip"
          }
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          New-Item -Path $DestDir -ItemType Directory -Force
          
          # å¤åˆ¶åº”ç”¨ç¨‹åºæ–‡ä»¶
          Copy-Item -Path "$SrcDir\*" -Destination $DestDir -Recurse -Force
          
          # å¤åˆ¶é¢å¤–çš„DLLæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if (Test-Path "Engine\windows\*.dll") {
            Copy-Item -Path "Engine\windows\*.dll" -Destination $DestDir -Force
          }
          
          # åˆ›å»ºZIPæ¡£æ¡ˆ
          Compress-Archive -Path $DestDir -DestinationPath "Engine\build\windows\$ZipName" -Force
          
          echo "artifact_name=$ZipName" >> $env:GITHUB_OUTPUT
          Write-Output "âœ… æ„å»ºå®Œæˆ: $ZipName"
      
      - name: Upload Windows App
        uses: actions/upload-artifact@v4
        with:
          name: release-Windows
          path: Engine/build/windows/*.zip
          retention-days: 90