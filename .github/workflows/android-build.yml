name: Android Build

on:
  workflow_call:
    inputs:
      flutter_version:
        required: false
        type: string
        default: '3.29.3'
      working_directory:
        required: false
        type: string
        default: '.'
      target_platform:
        required: false
        type: string
        default: 'android-arm64'
    outputs:
      version:
        description: "App version from pubspec.yaml"
        value: ${{ jobs.build-android.outputs.version }}
      artifact_name:
        description: "Generated artifact name"
        value: ${{ jobs.build-android.outputs.artifact_name }}

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      artifact_name: ${{ steps.build.outputs.artifact_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Get app version
        id: get_version
        working-directory: ${{ inputs.working_directory }}
        shell: bash
        run: |
          version=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Detected version: $version"
      
      - name: Setup Android keystore
        working-directory: ${{ inputs.working_directory }}
        env:
          ENCODED_KEYSTORE: ${{ secrets.ENCODED_KEYSTORE }}
          KEY_PROPERTIES: ${{ secrets.KEY_PROPERTIES }}
        run: |
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†ç­¾åå¯†é’¥
          if [ -z "$ENCODED_KEYSTORE" ] || [ -z "$KEY_PROPERTIES" ]; then
            echo "âŒ é”™è¯¯: æœªé…ç½®Androidç­¾åå¯†é’¥"
            echo "è¯·é…ç½®ä»¥ä¸‹GitHub Secrets:"
            echo "  - ENCODED_KEYSTORE: Base64ç¼–ç çš„keystoreæ–‡ä»¶"
            echo "  - KEY_PROPERTIES: ç­¾åé…ç½®æ–‡ä»¶å†…å®¹"
            echo ""
            echo "å‚è€ƒæ–‡æ¡£åˆ›å»ºç­¾åå¯†é’¥å’Œé…ç½®GitHub Secrets"
            exit 1
          fi
          
          echo "âœ… é…ç½®Androidç­¾åå¯†é’¥"
          echo "$ENCODED_KEYSTORE" | base64 -di > android/app/upload-keystore.jks
          echo "$KEY_PROPERTIES" > android/key.properties
          
          # éªŒè¯keystoreæ–‡ä»¶
          if [ ! -f "android/app/upload-keystore.jks" ]; then
            echo "âŒ é”™è¯¯: keystoreæ–‡ä»¶åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          echo "ğŸ” ç­¾åå¯†é’¥é…ç½®å®Œæˆ"
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          flutter-version: ${{ inputs.flutter_version }}
          channel: 'stable'
          cache: true
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: gradle
      
      - name: Flutter Pub Get
        working-directory: ${{ inputs.working_directory }}
        run: |
          git config --global core.longpaths true
          flutter pub get
      
      - name: Download and install mdk-sdk
        run: |
          echo "ğŸ“¥ ä¸‹è½½å¹¶å®‰è£… mdk-sdk"
          mkdir -p Engine/android/app/src/main/jniLibs/arm64-v8a
          curl -L -o mdk-sdk-android.7z https://sourceforge.net/projects/mdk-sdk/files/nightly/mdk-sdk-android.7z/download
          sudo apt-get update
          sudo apt-get install -y p7zip-full
          7z x mdk-sdk-android.7z -oEngine/android/app/src/main/jniLibs/arm64-v8a -y
      
      - name: Build Android APK
        id: build
        run: |
          echo "ğŸ”¨ ä½¿ç”¨build.shæ„å»ºAndroid APK"
          chmod +x build.sh
          ./build.sh android
          
          # æ£€æŸ¥APKæ˜¯å¦å­˜åœ¨
          apk_path="Engine/build/app/outputs/apk/release/app-release.apk"
          if [ ! -f "$apk_path" ]; then
            echo "âŒ APKæ„å»ºå¤±è´¥: $apk_path ä¸å­˜åœ¨"
            exit 1
          fi
          
          # ç”Ÿæˆæ„ä»¶åç§°å¹¶é‡å‘½åAPK
          version=$(grep '^version:' Engine/pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
          artifact_name="SakiEngine-${version}-Android-arm64-release.apk"
          
          cd Engine/build/app/outputs/apk/release
          mv app-release.apk "$artifact_name"
          
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
          echo "âœ… æ„å»ºå®Œæˆ: $artifact_name"
          
          # æ˜¾ç¤ºAPKä¿¡æ¯
          echo "ğŸ“± APKä¿¡æ¯:"
          ls -lh "$artifact_name"
      
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: release-Android
          path: Engine/build/app/outputs/apk/release/*.apk
          retention-days: 90