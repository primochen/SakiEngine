name: Linux Build

on:
  workflow_call:
    inputs:
      flutter_version:
        required: false
        type: string
        default: '3.35.1'
      working_directory:
        required: false
        type: string
        default: '.'
      architecture:
        required: false
        type: string
        default: 'amd64'
        description: 'Target architecture: amd64 or arm64'
    outputs:
      version:
        description: "App version from pubspec.yaml"
        value: ${{ jobs.build-linux.outputs.version }}
      artifact_name:
        description: "Generated artifact name"
        value: ${{ jobs.build-linux.outputs.artifact_name }}

jobs:
  build-linux:
    name: Build Linux App
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      artifact_name: ${{ steps.build.outputs.artifact_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Get app version
        id: get_version
        working-directory: ${{ inputs.working_directory }}
        shell: bash
        run: |
          version=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Detected version: $version"
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            mpv libmpv-dev \
            pkg-config \
            clang cmake \
            libgtk-3-dev \
            ninja-build \
            libasound2-dev \
            libass-dev \
            zip \
            libkeybinder-3.0-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-libav
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          flutter-version: ${{ inputs.flutter_version }}
          channel: 'stable'
          cache: true
      
      - name: Enable Linux desktop
        working-directory: ${{ inputs.working_directory }}
        run: |
          flutter config --enable-linux-desktop
      
      - name: Flutter Pub Get
        working-directory: ${{ inputs.working_directory }}
        run: |
          git config --global core.longpaths true
          flutter pub get
      
      - name: Build Linux App
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºLinuxåº”ç”¨"
          chmod +x build.sh

          # æ˜¾ç¤ºæ„å»ºå‰çš„ç¯å¢ƒä¿¡æ¯
          echo "Flutter ç‰ˆæœ¬:"
          flutter --version

          echo ""
          echo "è¿è¡Œ build.sh..."
          set -x  # æ˜¾ç¤ºæ‰§è¡Œçš„å‘½ä»¤
          ./build.sh linux || {
            echo "âŒ build.sh æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $?"
            echo "å°è¯•ç›´æ¥åœ¨ Engine ç›®å½•æ„å»º..."
            cd Engine
            flutter build linux --release -v
          }
          set +x

      - name: Verify Build Output
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºè¾“å‡º..."
          echo "ğŸ“ å®Œæ•´æ„å»ºç›®å½•æ ‘:"
          find Engine/build -type f -name "*.so" -o -type f -executable -o -type d -name "bundle" | head -50

          echo ""
          echo "ğŸ“¦ æ£€æŸ¥å¯èƒ½çš„ bundle ä½ç½®:"

          # æ£€æŸ¥å¤šä¸ªå¯èƒ½çš„ä½ç½®
          possible_locations=(
            "Engine/build/linux/x64/release/bundle"
            "Engine/build/linux/release/bundle"
            "Engine/build/linux/bundle"
          )

          bundle_found=false
          for location in "${possible_locations[@]}"; do
            if [ -d "$location" ]; then
              echo "âœ… æ‰¾åˆ° bundle åœ¨: $location"
              ls -lah "$location/"
              bundle_found=true
              break
            fi
          done

          if [ "$bundle_found" = false ]; then
            echo "âŒ åœ¨æ‰€æœ‰é¢„æœŸä½ç½®éƒ½æœªæ‰¾åˆ° bundle ç›®å½•"
            echo "Engine/build å®Œæ•´å†…å®¹:"
            ls -laR Engine/build/ | head -100
          fi

      - name: Package Linux App
        id: build
        run: |
          # ä»é¡¹ç›®æ ¹ç›®å½•è¯»å–æ¸¸æˆåç§°
          GAME_NAME=$(cat default_game.txt 2>/dev/null | tr -d '\n\r' | xargs)

          # å¦‚æœè¯»å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åç§°
          if [ -z "$GAME_NAME" ]; then
            GAME_NAME="SakiEngine"
            echo "âš ï¸  æ— æ³•è¯»å– default_game.txtï¼Œä½¿ç”¨é»˜è®¤åç§°: $GAME_NAME"
          fi

          # ä»Engineç›®å½•è¯»å–ç‰ˆæœ¬å·
          version=$(grep '^version:' Engine/pubspec.yaml 2>/dev/null | cut -d ' ' -f 2 | cut -d '+' -f 1)

          # å¦‚æœè¯»å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
          if [ -z "$version" ]; then
            version="1.0.0"
            echo "âš ï¸  æ— æ³•è¯»å–ç‰ˆæœ¬å·ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $version"
          fi

          arch="${{ inputs.architecture }}"
          artifact_name="${GAME_NAME}-${version}-Linux-${arch}.zip"

          echo "ğŸ” æ„å»ºä¿¡æ¯:"
          echo "   æ¸¸æˆåç§°: $GAME_NAME"
          echo "   ç‰ˆæœ¬å·: $version"
          echo "   æ¶æ„: $arch"
          echo "   è¾“å‡ºæ–‡ä»¶: $artifact_name"

          # æŸ¥æ‰¾ bundle ç›®å½•
          echo ""
          echo "ğŸ” æœç´¢ bundle ç›®å½•..."
          bundle_dir=$(find Engine/build/linux -type d -name "bundle" | head -1)

          if [ -z "$bundle_dir" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° bundle ç›®å½•"
            echo "Engine/build/linux å†…å®¹:"
            ls -laR Engine/build/linux/
            exit 1
          fi

          echo "âœ… æ‰¾åˆ° bundle ç›®å½•: $bundle_dir"
          echo ""
          echo "ğŸ“¦ bundle ç›®å½•å†…å®¹:"
          ls -lah "$bundle_dir/"

          # æ£€æŸ¥ bundle ç›®å½•æ˜¯å¦ä¸ºç©º
          if [ ! "$(ls -A $bundle_dir/)" ]; then
            echo "âŒ é”™è¯¯: bundle ç›®å½•æ˜¯ç©ºçš„ï¼"
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¯æ‰§è¡Œæ–‡ä»¶
          exe_count=$(find "$bundle_dir" -type f -executable | wc -l)
          echo "æ‰¾åˆ° $exe_count ä¸ªå¯æ‰§è¡Œæ–‡ä»¶"

          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæ‰“åŒ…
          PACKAGE_DIR="${GAME_NAME}-${version}-Linux-${arch}"
          mkdir -p "$PACKAGE_DIR"

          # å¤åˆ¶bundleç›®å½•çš„æ‰€æœ‰å†…å®¹åˆ°æ‰“åŒ…ç›®å½•
          echo ""
          echo "ğŸ“‹ æ­£åœ¨å¤åˆ¶æ–‡ä»¶åˆ°æ‰“åŒ…ç›®å½•..."
          cp -r "$bundle_dir"/* "$PACKAGE_DIR/"

          # éªŒè¯å¤åˆ¶ç»“æœ
          echo "æ‰“åŒ…ç›®å½•å†…å®¹:"
          ls -lah "$PACKAGE_DIR/"

          # åˆ›å»ºZIPæ¡£æ¡ˆ
          echo ""
          echo "ğŸ—œï¸  æ­£åœ¨åˆ›å»ºZIPæ–‡ä»¶..."
          zip -r "$artifact_name" "$PACKAGE_DIR"

          # éªŒè¯ZIPæ–‡ä»¶
          if [ ! -f "$artifact_name" ]; then
            echo "âŒ é”™è¯¯: ZIPæ–‡ä»¶åˆ›å»ºå¤±è´¥"
            exit 1
          fi

          zip_size=$(du -h "$artifact_name" | cut -f1)
          echo "âœ… ZIPåˆ›å»ºæˆåŠŸ: $artifact_name (å¤§å°: $zip_size)"

          # æ˜¾ç¤ºZIPå†…å®¹ç”¨äºéªŒè¯
          echo ""
          echo "ğŸ“‹ ZIPæ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          unzip -l "$artifact_name" | head -30

          echo ""
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
          echo "âœ… æ‰“åŒ…å®Œæˆ: $artifact_name"
      
      - name: Upload Linux App
        uses: actions/upload-artifact@v4
        with:
          name: release-Linux-${{ inputs.architecture }}
          path: ./*.zip
          retention-days: 90