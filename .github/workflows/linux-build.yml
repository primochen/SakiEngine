name: Linux Build

on:
  workflow_call:
    inputs:
      flutter_version:
        required: false
        type: string
        default: '3.35.1'
      working_directory:
        required: false
        type: string
        default: '.'
      architecture:
        required: false
        type: string
        default: 'amd64'
        description: 'Target architecture: amd64 or arm64'
    outputs:
      version:
        description: "App version from pubspec.yaml"
        value: ${{ jobs.build-linux.outputs.version }}
      artifact_name:
        description: "Generated artifact name"
        value: ${{ jobs.build-linux.outputs.artifact_name }}

jobs:
  build-linux:
    name: Build Linux App
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      artifact_name: ${{ steps.build.outputs.artifact_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Get app version
        id: get_version
        working-directory: ${{ inputs.working_directory }}
        shell: bash
        run: |
          version=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Detected version: $version"
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            mpv libmpv-dev \
            pkg-config \
            clang cmake \
            libgtk-3-dev \
            ninja-build \
            libasound2-dev \
            libass-dev \
            zip \
            libkeybinder-3.0-dev
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          flutter-version: ${{ inputs.flutter_version }}
          channel: 'stable'
          cache: true
      
      - name: Enable Linux desktop
        working-directory: ${{ inputs.working_directory }}
        run: |
          flutter config --enable-linux-desktop
      
      - name: Flutter Pub Get
        working-directory: ${{ inputs.working_directory }}
        run: |
          git config --global core.longpaths true
          flutter pub get
      
      - name: Build Linux App
        run: |
          echo "ğŸ”¨ ä½¿ç”¨build.shæ„å»ºLinuxåº”ç”¨"
          chmod +x build.sh
          ./build.sh linux

      - name: Verify Build Output
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºè¾“å‡º..."
          echo "ğŸ“ Engine/build ç›®å½•ç»“æ„:"
          ls -laR Engine/build/linux/ || echo "æ„å»ºç›®å½•ä¸å­˜åœ¨"

          echo ""
          echo "ğŸ“¦ æ£€æŸ¥ bundle ç›®å½•:"
          if [ -d "Engine/build/linux/x64/release/bundle" ]; then
            echo "âœ… bundle ç›®å½•å­˜åœ¨"
            ls -lah Engine/build/linux/x64/release/bundle/

            echo ""
            echo "ğŸ” æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶:"
            find Engine/build/linux/x64/release/bundle -type f -executable -ls

            echo ""
            echo "ğŸ“Š bundle ç›®å½•å¤§å°:"
            du -sh Engine/build/linux/x64/release/bundle/
          else
            echo "âŒ bundle ç›®å½•ä¸å­˜åœ¨ï¼"
            echo "å°è¯•æŸ¥æ‰¾æ„å»ºè¾“å‡º..."
            find Engine/build -type f -name "*.so" -o -type f -executable | head -20
          fi

      - name: Package Linux App
        id: build
        run: |
          cd Engine/build/linux/x64/release

          # ä»é¡¹ç›®æ ¹ç›®å½•è¯»å–æ¸¸æˆåç§°ï¼ˆä¿®æ­£ç›¸å¯¹è·¯å¾„ä¸º5å±‚ï¼‰
          GAME_NAME=$(cat ../../../../../default_game.txt 2>/dev/null | tr -d '\n\r' | xargs)

          # å¦‚æœè¯»å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åç§°
          if [ -z "$GAME_NAME" ]; then
            GAME_NAME="SakiEngine"
            echo "âš ï¸  æ— æ³•è¯»å– default_game.txtï¼Œä½¿ç”¨é»˜è®¤åç§°: $GAME_NAME"
          fi

          # ä»Engineç›®å½•è¯»å–ç‰ˆæœ¬å·ï¼ˆä¿®æ­£ç›¸å¯¹è·¯å¾„ä¸º5å±‚ï¼‰
          version=$(grep '^version:' ../../../../../Engine/pubspec.yaml 2>/dev/null | cut -d ' ' -f 2 | cut -d '+' -f 1)

          # å¦‚æœè¯»å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
          if [ -z "$version" ]; then
            version="1.0.0"
            echo "âš ï¸  æ— æ³•è¯»å–ç‰ˆæœ¬å·ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $version"
          fi

          arch="${{ inputs.architecture }}"
          artifact_name="${GAME_NAME}-${version}-Linux-${arch}.zip"

          echo "ğŸ” æ„å»ºä¿¡æ¯:"
          echo "   å½“å‰è·¯å¾„: $(pwd)"
          echo "   æ¸¸æˆåç§°: $GAME_NAME"
          echo "   ç‰ˆæœ¬å·: $version"
          echo "   æ¶æ„: $arch"
          echo "   è¾“å‡ºæ–‡ä»¶: $artifact_name"

          # æ˜¾ç¤ºå½“å‰ç›®å½•ç»“æ„ç”¨äºè°ƒè¯•
          echo ""
          echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
          ls -la

          # Flutter Linuxæ„å»ºè¾“å‡ºåœ¨bundleç›®å½•ä¸‹
          if [ ! -d "bundle" ]; then
            echo ""
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° bundle ç›®å½•"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -laR
            echo ""
            echo "å°è¯•æŸ¥æ‰¾å¯èƒ½çš„è¾“å‡ºä½ç½®:"
            find ../.. -type d -name "bundle" 2>/dev/null || true
            exit 1
          fi

          echo ""
          echo "ğŸ“¦ æ‰¾åˆ° bundle ç›®å½•ï¼Œæ˜¾ç¤ºå…¶å†…å®¹:"
          ls -lah bundle/

          # æ£€æŸ¥ bundle ç›®å½•æ˜¯å¦ä¸ºç©º
          if [ ! "$(ls -A bundle/)" ]; then
            echo "âŒ é”™è¯¯: bundle ç›®å½•æ˜¯ç©ºçš„ï¼"
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¯æ‰§è¡Œæ–‡ä»¶
          if [ ! -f "bundle/${GAME_NAME}" ] && [ ! -f "bundle/sakiengine" ]; then
            echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ°é¢„æœŸçš„å¯æ‰§è¡Œæ–‡ä»¶ bundle/${GAME_NAME}"
            echo "bundle ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶:"
            find bundle/ -type f -executable -ls || echo "æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          fi

          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæ‰“åŒ…
          PACKAGE_DIR="${GAME_NAME}-${version}-Linux-${arch}"
          mkdir -p "$PACKAGE_DIR"

          # å¤åˆ¶bundleç›®å½•çš„æ‰€æœ‰å†…å®¹åˆ°æ‰“åŒ…ç›®å½•
          echo ""
          echo "ğŸ“‹ æ­£åœ¨å¤åˆ¶æ–‡ä»¶åˆ°æ‰“åŒ…ç›®å½•..."
          cp -r bundle/* "$PACKAGE_DIR/"

          # éªŒè¯å¤åˆ¶ç»“æœ
          echo "æ‰“åŒ…ç›®å½•å†…å®¹:"
          ls -lah "$PACKAGE_DIR/"

          # åˆ›å»ºZIPæ¡£æ¡ˆ
          echo ""
          echo "ğŸ—œï¸  æ­£åœ¨åˆ›å»ºZIPæ–‡ä»¶..."
          zip -r "$artifact_name" "$PACKAGE_DIR"

          # éªŒè¯ZIPæ–‡ä»¶
          if [ ! -f "$artifact_name" ]; then
            echo "âŒ é”™è¯¯: ZIPæ–‡ä»¶åˆ›å»ºå¤±è´¥"
            exit 1
          fi

          zip_size=$(du -h "$artifact_name" | cut -f1)
          echo "âœ… ä½¿ç”¨ bundle ç›®å½•åˆ›å»ºZIP: $artifact_name (å¤§å°: $zip_size)"

          # æ˜¾ç¤ºZIPå†…å®¹ç”¨äºéªŒè¯
          echo ""
          echo "ğŸ“‹ ZIPæ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          unzip -l "$artifact_name" | head -30

          echo ""
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
          echo "âœ… æ‰“åŒ…å®Œæˆ: $artifact_name"
      
      - name: Upload Linux App
        uses: actions/upload-artifact@v4
        with:
          name: release-Linux-${{ inputs.architecture }}
          path: Engine/build/linux/x64/release/*.zip
          retention-days: 90