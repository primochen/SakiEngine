name: macOS Build

on:
  workflow_call:
    inputs:
      flutter_version:
        required: false
        type: string
        default: '3.29.3'
      working_directory:
        required: false
        type: string
        default: '.'
      create_dmg:
        required: false
        type: boolean
        default: true
    outputs:
      version:
        description: "App version from pubspec.yaml"
        value: ${{ jobs.build-macos.outputs.version }}
      artifact_name:
        description: "Generated artifact name"
        value: ${{ jobs.build-macos.outputs.artifact_name }}

jobs:
  build-macos:
    name: Build macOS App
    runs-on: macos-13
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      artifact_name: ${{ steps.build.outputs.artifact_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Get app version
        id: get_version
        working-directory: ${{ inputs.working_directory }}
        shell: bash
        run: |
          version=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Detected version: $version"
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          flutter-version: ${{ inputs.flutter_version }}
          channel: 'stable'
          cache: true
      
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          key: macos-pods-${{ hashFiles(format('{0}/macos/Podfile.lock', inputs.working_directory)) }}
          path: ${{ inputs.working_directory }}/macos/Pods
          restore-keys: |
            macos-pods-
      
      - name: Flutter Pub Get
        working-directory: ${{ inputs.working_directory }}
        run: |
          git config --global core.longpaths true
          flutter pub get
      
      - name: Build macOS App
        run: |
          echo "ğŸ”¨ ä½¿ç”¨build.shæ„å»ºmacOSåº”ç”¨"
          chmod +x build.sh
          ./build.sh macos
      
      - name: Create DMG or ZIP
        id: build
        run: |
          cd Engine/build/macos/Build/Products/Release
          
          # ä»é¡¹ç›®æ ¹ç›®å½•è¯»å–æ¸¸æˆåç§°ï¼ˆä¿®æ­£ç›¸å¯¹è·¯å¾„ä¸º8å±‚ï¼‰
          GAME_NAME=$(cat ../../../../../../../../default_game.txt 2>/dev/null | tr -d '\n\r' | xargs)
          
          # å¦‚æœè¯»å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åç§°
          if [ -z "$GAME_NAME" ]; then
            GAME_NAME="SakiEngine"
            echo "âš ï¸  æ— æ³•è¯»å– default_game.txtï¼Œä½¿ç”¨é»˜è®¤åç§°: $GAME_NAME"
          fi
          
          APP_NAME="$GAME_NAME.app"
          
          echo "ğŸ” æ„å»ºä¿¡æ¯:"
          echo "   å½“å‰è·¯å¾„: $(pwd)"
          echo "   æ¸¸æˆåç§°: $GAME_NAME"
          echo "   åº”ç”¨åç§°: $APP_NAME"

          # æ£€æŸ¥ .app æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -d "$APP_NAME" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°åº”ç”¨ '$APP_NAME'ã€‚"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          # ä»Engineç›®å½•è¯»å–ç‰ˆæœ¬å·ï¼ˆä¿®æ­£ç›¸å¯¹è·¯å¾„ä¸º8å±‚ï¼‰
          version=$(grep '^version:' ../../../../../../../../Engine/pubspec.yaml 2>/dev/null | cut -d ' ' -f 2 | cut -d '+' -f 1)
          
          # å¦‚æœè¯»å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
          if [ -z "$version" ]; then
            version="1.0.0"
            echo "âš ï¸  æ— æ³•è¯»å–ç‰ˆæœ¬å·ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $version"
          fi
          
          echo "   ç‰ˆæœ¬å·: $version"
          
          if [ "${{ inputs.create_dmg }}" = "true" ]; then
            # åˆ›å»ºDMG
            mkdir -p dmg-contents
            cp -R "$APP_NAME" dmg-contents/
            artifact_name="${GAME_NAME}-${version}-macOS-arm64.dmg"
            hdiutil create -srcfolder dmg-contents -volname "$GAME_NAME" -format UDZO "$artifact_name"
            echo "âœ… åˆ›å»ºDMG: $artifact_name"
          else
            # åˆ›å»ºZIP
            artifact_name="${GAME_NAME}-${version}-macOS-arm64.zip"
            zip -r "$artifact_name" "$APP_NAME"
            echo "âœ… åˆ›å»ºZIP: $artifact_name"
          fi
          
          echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
          echo "âœ… æ„å»ºå®Œæˆ: $artifact_name"
      
      - name: Upload macOS App
        uses: actions/upload-artifact@v4
        with:
          name: release-macOS
          path: |
            Engine/build/macos/Build/Products/Release/*.dmg
            Engine/build/macos/Build/Products/Release/*.zip
          retention-days: 90